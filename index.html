<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Smart Portfolio Allocator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      /* Light & Dark background overrides */
      --dark-bg: #232a31; /* a dark grey with a hint of navy blue */
      --dark-text: #ffffff;
      --dark-input-bg: #0000FF; /* pure blue for inputs in dark mode */
      --dark-input-text: #ffffff;
      --light-bg: #f9f9f9;
      --light-text: #333;
      --light-input-bg: #ffffff;
      --light-input-text: #333;

      --remove-btn: #FF0000; /* pure red */
      --add-btn:    #00FF00; /* pure green */
      --calc-btn:   #00FFFF; /* cyan */

      --input-scale: 0.85; 
      --label-font:  0.85em;
      --field-font:  0.8em;
    }

    html, body {
      margin: 0; padding: 0;
      font-family: Arial, sans-serif;
      font-size: 110%;
      transition: background-color 0.3s, color 0.3s;
    }

    /* THEME MODES */
    body.light-mode {
      background-color: var(--light-bg);
      color: var(--light-text);
    }
    body.light-mode input, body.light-mode select {
      background-color: var(--light-input-bg);
      color: var(--light-input-text);
    }
    body.dark-mode {
      background-color: var(--dark-bg);
      color: var(--dark-text);
    }
    body.dark-mode input, body.dark-mode select {
      background-color: var(--dark-input-bg);
      color: var(--dark-input-text);
      border: 1px solid #666;
    }
    @media (prefers-color-scheme: dark) {
      body.system-mode {
        background-color: var(--dark-bg);
        color: var(--dark-text);
      }
      body.system-mode input, body.system-mode select {
        background-color: var(--dark-input-bg);
        color: var(--dark-input-text);
      }
    }
    @media (prefers-color-scheme: light) {
      body.system-mode {
        background-color: var(--light-bg);
        color: var(--light-text);
      }
      body.system-mode input, body.system-mode select {
        background-color: var(--light-input-bg);
        color: var(--light-input-text);
      }
    }

    /* MAIN HEADING & SUBHEAD EXACTLY CENTERED */
    .main-heading {
      text-align: center;
      margin: 20px 0 0 0;
    }
    .subheading {
      text-align: center;
      margin: 0 0 20px 0;
      font-size: 0.9em;
    }

    /* ICON ROW (theme toggle, download, instructions) */
    .icon-row {
      display: flex;
      justify-content: center;
      align-items: flex-end;
      gap: 20px;
      margin-bottom: 20px;
    }
    .icon-field {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .icon-field label {
      font-size: 0.9em;
      margin-bottom: 5px;
    }
    .icon-row button {
      background: none;
      border: none;
      font-size: 1.2em;
      cursor: pointer;
      position: relative;
    }
    .theme-status {
      position: absolute;
      top: -15px; right: 0;
      font-size: 0.8em;
      opacity: 0;
      transition: opacity 0.3s;
    }

    /* MAIN CONTAINER, CENTERED */
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      text-align: center;
    }

    /* LAYOUT FOR TOP INPUTS */
    .flex-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 10px;
      width: 100%;
    }
    .flex-col {
      display: flex;
      flex-direction: column;
      margin-right: 30px;
      margin-bottom: 10px;
      align-items: flex-start;
    }

    label {
      margin-bottom: 4px;
      font-size: var(--label-font);
    }
    input, select {
      transform: scale(var(--input-scale));
      transform-origin: top left;
      padding: 4px 6px;
      font-size: var(--field-font);
      border: 1px solid #ccc;
      outline: none;
    }
    button {
      padding: 4px 10px;
      font-size: 0.9em;
      border-radius: 0;
      border: none;
      margin: 5px;
      cursor: pointer;
    }

    .btn-remove {
      background-color: var(--remove-btn);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 24px;          /* slightly smaller height */
      margin-top: 4px;       /* SHIFT button down a bit relative to the row baseline */
    }
    .btn-add {
      background-color: var(--add-btn);
      color: #000;
    }
    .btn-get-rates {
      background-color: var(--remove-btn);
      color: #fff;
    }
    .btn-calculate {
      background-color: var(--calc-btn);
      color: #000;
    }

    /* POSITIONS LAYOUT */
    .positions-container {
      margin-bottom: 20px;
      display: inline-block;
      text-align: left;
    }
    .positions-header-row {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }
    .position-row {
      display: flex;
      align-items: flex-end; /* align at bottom so they're consistent with base/stable labels */
      margin-bottom: 10px;
    }
    .position-field {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      margin-right: 15px;
    }
    .ticker-input {
      width: 70px;
    }
    .percent-select {
      width: 80px;
    }
    .base-input, .stable-input {
      width: 80px;
      height: 24px;
    }

    /* CHECK label & box, SHIFT them up to match remove button & base/stable */
    .check-label {
      font-size: var(--label-font);
      margin-bottom: 2px; /* smaller gap */
    }
    .check-box {
      width: 24px;
      height: 24px;
      border: 1px solid #999;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1em;
      user-select: none;
      margin-left: 5px;
      margin-top: 2px; /* SHIFT up a bit */
    }
    .check-active {
      background-color: #0f0; /* green highlight */
      color: #000;
    }

    /* RESULTS TABLE */
    table {
      margin: 20px auto;
      border-collapse: collapse;
      width: 90%;
      max-width: 1000px;
      font-size: 0.9em;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }

    /* POPUPS (DOWNLOAD & INSTRUCTIONS) */
    .popup-bg, .instructions-bg {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.4);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .popup, .instructions {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      max-width: 300px;
      text-align: left;
      color: #000;
      font-size: 0.9em;
    }
    /* Dark mode popups, with the new background color (#222 or #232a31) for consistency */
    body.dark-mode #downloadPopup .popup,
    body.dark-mode #instructionsPopup .instructions {
      background: #222 !important;
      color: #fff !important;
    }

    .popup button, .instructions button {
      margin: 5px 0;
      width: 100%;
      font-size: 0.9em;
      cursor: pointer;
    }
    .popup button:hover, .instructions button:hover {
      background: #eee;
    }
    .instructions h3 {
      margin-top: 0; margin-bottom: 5px;
    }
    .instructions ul {
      margin: 0; padding-left: 20px; list-style: disc;
    }
  </style>
</head>
<body class="light-mode">
  <!-- Minimal HTML for PDF creation, with better styling -->
  <script>
    function createPDF(content){
      const w=window.open("","_blank");
      if(!w){alert("Popups blocked!");return;}
      // Polished minimal HTML for PDF
      let polishedHTML=`
      <html>
      <head>
        <meta charset="utf-8"/>
        <style>
          body {
            font-family: Arial, sans-serif;
            margin: 30px;
            color: #000;
          }
          h1,h2 {
            text-align: center;
            margin: 0 0 15px;
          }
          .header {
            text-align: center;
            margin-bottom: 15px;
          }
          table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
          }
          th, td {
            border: 1px solid #999;
            padding: 8px;
            text-align: center;
            font-size: 14px;
          }
        </style>
      </head>
      <body>
        <h1>Smart Portfolio Allocator</h1>
        <div class="header">
          <p><strong>Date:</strong> ${new Date().toLocaleString()}</p>
        </div>
        ${content}
      </body>
      </html>
      `;
      w.document.open();
      w.document.write(polishedHTML);
      w.document.close();
      w.focus();
      w.print();
      w.close();
    }
  </script>

  <!-- Heading + subheading -->
  <h1 class="main-heading">Smart Portfolio Allocator</h1>
  <div class="subheading">© CSQ Global</div>

  <!-- ICON ROW with labels above each icon -->
  <div class="icon-row">
    <div class="icon-field">
      <label>Theme</label>
      <button id="themeToggleBtn" onclick="cycleTheme()">☀️
        <span class="theme-status" id="themeStatus"></span>
      </button>
    </div>
    <div class="icon-field">
      <label>Download</label>
      <button id="downloadBtn" onclick="showDownloadPopup()">⤵️</button>
    </div>
    <div class="icon-field">
      <label>Instructions</label>
      <button id="infoBtn" onclick="toggleInstructions()">ℹ️</button>
    </div>
  </div>

  <!-- Download popup -->
  <div class="popup-bg" id="downloadPopup" style="display:none;">
    <div class="popup">
      <p><strong>Choose Download Format:</strong></p>
      <button onclick="downloadPDF()">Download as PDF</button>
      <button onclick="downloadCSV()">Download as CSV</button>
      <button onclick="closeDownloadPopup()">Cancel</button>
    </div>
  </div>

  <!-- Instructions popup -->
  <div class="instructions-bg" id="instructionsPopup" style="display:none;">
    <div class="instructions">
      <h3>Smart Portfolio Allocator Instructions</h3>
      <p><em>© CSQ Global 2025</em></p>
      <p><strong>What It’s For:</strong></p>
      <ul>
        <li>Quickly allocate fiat or stablecoins across your crypto portfolio.</li>
        <li>See immediate conversions and final distributions.</li>
      </ul>
      <p><strong>How to Use It:</strong></p>
      <ul>
        <li>Choose your base currency &amp; amount to invest.</li>
        <li>Select your conversion currency &amp; stablecoin.</li>
        <li>Pick core/spec/reserve percentages (total ~100%).</li>
        <li>Click <em>Calculate Allocations</em> to see final distribution.</li>
        <li>Use the small check-box if you want to mark that position as done.</li>
      </ul>
      <p>Short &amp; sweet – enjoy allocating your funds!</p>
      <button onclick="toggleInstructions()">Close</button>
    </div>
  </div>

  <div class="container">
    <!-- 1) Base Currency + Amount -->
    <div class="flex-row">
      <div class="flex-col">
        <label for="baseCurrency">Base Currency</label>
        <select id="baseCurrency" onchange="showImmediateConversions()">
          <option value="AUD" selected>AUD</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
          <option value="CAD">CAD</option>
          <option value="CHF">CHF</option>
          <option value="JPY">JPY</option>
          <option value="CNY">CNY</option>
          <option value="HKD">HKD</option>
          <option value="NZD">NZD</option>
          <option value="SEK">SEK</option>
          <option value="SGD">SGD</option>
          <option value="ZAR">ZAR</option>
          <option value="INR">INR</option>
          <option value="KRW">KRW</option>
          <option value="AED">AED</option>
          <option value="BRL">BRL</option>
          <option value="MXN">MXN</option>
          <option value="RUB">RUB</option>
          <option value="TRY">TRY</option>
        </select>
      </div>
      <div class="flex-col">
        <label for="investmentAmount">Amount to Invest</label>
        <!-- Default 60000 -->
        <input type="number" id="investmentAmount" step="any" placeholder="Enter amount" value="60000"
               oninput="showImmediateConversions()">
      </div>
    </div>

    <!-- 2) Conversion + Stablecoin + Get Rates -->
    <div class="flex-row">
      <div class="flex-col">
        <label for="conversionCurrency">Conversion Currency</label>
        <select id="conversionCurrency" onchange="showImmediateConversions()">
          <option value="AED" selected>AED</option>
          <option value="AUD">AUD</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
          <option value="CAD">CAD</option>
          <option value="CHF">CHF</option>
          <option value="JPY">JPY</option>
          <option value="CNY">CNY</option>
          <option value="HKD">HKD</option>
          <option value="NZD">NZD</option>
          <option value="SEK">SEK</option>
          <option value="SGD">SGD</option>
          <option value="ZAR">ZAR</option>
          <option value="INR">INR</option>
          <option value="KRW">KRW</option>
          <option value="BRL">BRL</option>
          <option value="MXN">MXN</option>
          <option value="RUB">RUB</option>
          <option value="TRY">TRY</option>
        </select>
      </div>
      <div class="flex-col">
        <label for="stablecoin">Stablecoin</label>
        <select id="stablecoin" onchange="showImmediateConversions()">
          <option value="USDT" selected>USDT</option>
          <option value="USDC">USDC</option>
        </select>
      </div>
      <div class="flex-col">
        <label>Live Rates</label>
        <button class="btn-get-rates" onclick="updateExchangeRates()">Get Live Rates</button>
      </div>
    </div>

    <div id="immediateConversionDisplay" style="margin-bottom:15px;"></div>

    <!-- 3) Category %: default: Core=75, Spec=25, Reserve=10 -->
    <div class="flex-row">
      <div class="flex-col">
        <label for="corePct">Core % of Total</label>
        <select id="corePct">
          <option value="0">0%</option>
          <option value="5">5%</option>
          <option value="10">10%</option>
          <option value="15">15%</option>
          <option value="20">20%</option>
          <option value="25">25%</option>
          <option value="30">30%</option>
          <option value="35">35%</option>
          <option value="40">40%</option>
          <option value="45">45%</option>
          <option value="50">50%</option>
          <option value="55">55%</option>
          <option value="60">60%</option>
          <option value="65">65%</option>
          <option value="70">70%</option>
          <option value="75" selected>75%</option>
          <option value="80">80%</option>
          <option value="85">85%</option>
          <option value="90">90%</option>
          <option value="95">95%</option>
          <option value="100">100%</option>
        </select>
      </div>
      <div class="flex-col">
        <label for="specPct">Spec % of Total</label>
        <select id="specPct">
          <option value="0">0%</option>
          <option value="5">5%</option>
          <option value="10">10%</option>
          <option value="15">15%</option>
          <option value="20">20%</option>
          <option value="25" selected>25%</option>
          <option value="30">30%</option>
          <option value="35">35%</option>
          <option value="40">40%</option>
          <option value="45">45%</option>
          <option value="50">50%</option>
          <option value="55">55%</option>
          <option value="60">60%</option>
          <option value="65">65%</option>
          <option value="70">70%</option>
          <option value="75">75%</option>
          <option value="80">80%</option>
          <option value="85">85%</option>
          <option value="90">90%</option>
          <option value="95">95%</option>
          <option value="100">100%</option>
        </select>
      </div>
      <div class="flex-col">
        <label for="reservePct">Reserve % of Total</label>
        <select id="reservePct">
          <option value="0">0%</option>
          <option value="5">5%</option>
          <option value="10" selected>10%</option>
          <option value="15">15%</option>
          <option value="20">20%</option>
          <option value="25">25%</option>
          <option value="30">30%</option>
          <option value="35">35%</option>
          <option value="40">40%</option>
          <option value="45">45%</option>
          <option value="50">50%</option>
          <option value="55">55%</option>
          <option value="60">60%</option>
          <option value="65">65%</option>
          <option value="70">70%</option>
          <option value="75">75%</option>
          <option value="80">80%</option>
          <option value="85">85%</option>
          <option value="90">90%</option>
          <option value="95">95%</option>
          <option value="100">100%</option>
        </select>
      </div>
    </div>

    <!-- CORE POSITIONS -->
    <div class="positions-container">
      <div class="positions-header-row">
        <h2 style="margin:0;">Core Positions</h2>
        <button class="btn-calculate" onclick="calculateAllocations()">Calculate Allocations</button>
      </div>
      <div id="corePositionsList"></div>
      <button class="btn-add" onclick="addPosition('core')">Add Core Position</button>
    </div>

    <!-- SPECULATIVE POSITIONS -->
    <div class="positions-container">
      <h2 style="margin:0;">Speculative Positions</h2>
      <div id="specPositionsList"></div>
      <button class="btn-add" onclick="addPosition('spec')">Add Spec Position</button>
    </div>

    <!-- RESERVE POSITIONS -->
    <div class="positions-container">
      <h2 style="margin:0;">Reserve Positions</h2>
      <div id="reservePositionsList"></div>
      <div class="bottom-btn-row">
        <button class="btn-add" onclick="addPosition('reserve')">Add Reserve Position</button>
        <button class="btn-calculate" onclick="calculateAllocations()">Calculate Allocations</button>
      </div>
    </div>

    <!-- RESULTS -->
    <div id="results"></div>
  </div>

  <script>
    /************************************************
     THEME TOGGLE
    ************************************************/
    let themeModeIndex=0;
    const themeIcons=["☀️","🌙","💻"];
    const themeLabels=["Light","Dark","System"];
    function cycleTheme(){
      themeModeIndex=(themeModeIndex+1)%3;
      applyTheme();
      showThemeStatus(themeLabels[themeModeIndex]);
    }
    function applyTheme(){
      document.body.classList.remove("light-mode","dark-mode","system-mode");
      if(themeModeIndex===0) document.body.classList.add("light-mode");
      else if(themeModeIndex===1) document.body.classList.add("dark-mode");
      else document.body.classList.add("system-mode");
      document.getElementById("themeToggleBtn").textContent=themeIcons[themeModeIndex];
      saveTheme();
    }
    function showThemeStatus(msg){
      const st=document.getElementById("themeStatus");
      st.textContent=msg;
      st.style.opacity="1";
      setTimeout(()=>{st.style.opacity="0";},1500);
    }
    function saveTheme(){
      localStorage.setItem("themeModeIndex",themeModeIndex.toString());
    }
    function loadTheme(){
      const t=localStorage.getItem("themeModeIndex");
      if(t!==null){
        themeModeIndex=parseInt(t,10);
        applyTheme();
      }
    }

    /************************************************
     POPUP CONTROL (Download, Instructions)
    ************************************************/
    function showDownloadPopup(){
      document.getElementById("downloadPopup").style.display="flex";
    }
    function closeDownloadPopup(){
      document.getElementById("downloadPopup").style.display="none";
    }
    function toggleInstructions(){
      const pop=document.getElementById("instructionsPopup");
      pop.style.display=(pop.style.display==="flex")?"none":"flex";
    }

    /************************************************
     PDF & CSV
    ************************************************/
    function downloadPDF(){
      closeDownloadPopup();
      const resultsEl=document.getElementById("results");
      if(!resultsEl||!resultsEl.textContent.trim()){
        alert("No results to export. Please Calculate Allocations first.");
        return;
      }
      // We'll pass the final HTML to createPDF
      createPDF(resultsEl.innerHTML);
    }
    function downloadCSV(){
      closeDownloadPopup();
      const resultsEl=document.getElementById("results");
      if(!resultsEl||!resultsEl.textContent.trim()){
        alert("No results to export. Please Calculate Allocations first.");
        return;
      }
      const rows=Array.from(resultsEl.querySelectorAll("table tr"));
      let csv="";
      rows.forEach(row=>{
        const cells=Array.from(row.querySelectorAll("th,td")).map(c=>c.innerText.replace(/,/g,""));
        csv+=cells.join(",")+"\n";
      });
      const blob=new Blob([csv],{type:"text/csv"});
      const url=URL.createObjectURL(blob);
      const a=document.createElement("a");
      a.href=url;
      a.download="allocation.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    /************************************************
     DATA FOR POSITIONS
    ************************************************/
    let corePositions=[], specPositions=[], reservePositions=[];
    let exchangeData={};

    window.onload=function(){
      loadTheme();
      loadPositions();
      renderAllPositions();
      updateExchangeRates();

      // Default percentages
      document.getElementById("corePct").value   = "75";
      document.getElementById("specPct").value   = "25";
      document.getElementById("reservePct").value= "10";
      document.getElementById("investmentAmount").value="60000";
    };

    function addPosition(cat){
      const id=cat+"-"+Date.now();
      const newObj={id,ticker:"",percentOfFull:"",baseAlloc:"",stableAlloc:"",checked:false};
      if(cat==="core") corePositions.push(newObj);
      else if(cat==="spec") specPositions.push(newObj);
      else reservePositions.push(newObj);
      savePositions();
      renderAllPositions();
    }
    function removePosition(cat,id){
      if(cat==="core") corePositions=corePositions.filter(p=>p.id!==id);
      else if(cat==="spec") specPositions=specPositions.filter(p=>p.id!==id);
      else reservePositions=reservePositions.filter(p=>p.id!==id);
      savePositions();
      renderAllPositions();
    }

    function renderAllPositions(){
      const cList=document.getElementById("corePositionsList");
      const sList=document.getElementById("specPositionsList");
      const rList=document.getElementById("reservePositionsList");
      cList.innerHTML=""; sList.innerHTML=""; rList.innerHTML="";

      corePositions.forEach(pos=>cList.appendChild(createPositionRow(pos,"core")));
      specPositions.forEach(pos=>sList.appendChild(createPositionRow(pos,"spec")));
      reservePositions.forEach(pos=>rList.appendChild(createPositionRow(pos,"reserve")));
    }

    /* Row with Ticker, % , Base, Stable, Remove, Tick */
    function createPositionRow(pos,cat){
      const row=document.createElement("div");
      row.className="position-row";

      // Ticker
      const tickerWrap=document.createElement("div");
      tickerWrap.className="position-field";
      const tickerLabel=document.createElement("label");
      tickerLabel.textContent="Ticker";
      const tickerInput=document.createElement("input");
      tickerInput.type="text";
      tickerInput.value=pos.ticker;
      tickerInput.classList.add("ticker-input");
      tickerInput.onchange=()=>updateTicker(cat,pos.id,tickerInput.value);
      tickerWrap.appendChild(tickerLabel);
      tickerWrap.appendChild(tickerInput);

      // % of Full
      const percentWrap=document.createElement("div");
      percentWrap.className="position-field";
      const percentLabel=document.createElement("label");
      percentLabel.textContent="Select %";
      const percentSelect=document.createElement("select");
      percentSelect.innerHTML=`
        <option value="">(Select %)</option>
        <option value="0.25">25%</option>
        <option value="0.5">50%</option>
        <option value="0.75">75%</option>
        <option value="1">100%</option>
        <option value="2">200%</option>
        <option value="3">300%</option>
      `;
      percentSelect.value=pos.percentOfFull;
      percentSelect.classList.add("percent-select");
      percentSelect.onchange=()=>updatePercentOfFull(cat,pos.id,percentSelect.value);
      percentWrap.appendChild(percentLabel);
      percentWrap.appendChild(percentSelect);

      // Base Alloc
      const baseWrap=document.createElement("div");
      baseWrap.className="position-field";
      const baseLabel=document.createElement("label");
      baseLabel.textContent="Base Alloc";
      const baseInput=document.createElement("input");
      baseInput.type="text";
      baseInput.readOnly=true;
      baseInput.classList.add("base-input");
      baseInput.value=pos.baseAlloc||"";
      baseWrap.appendChild(baseLabel);
      baseWrap.appendChild(baseInput);

      // Stable Alloc
      const stableWrap=document.createElement("div");
      stableWrap.className="position-field";
      const stableLabel=document.createElement("label");
      stableLabel.textContent="Stable Alloc";
      const stableInput=document.createElement("input");
      stableInput.type="text";
      stableInput.readOnly=true;
      stableInput.classList.add("stable-input");
      stableInput.value=pos.stableAlloc||"";
      stableWrap.appendChild(stableLabel);
      stableWrap.appendChild(stableInput);

      // Remove
      const rmBtn=document.createElement("button");
      rmBtn.className="btn-remove";
      rmBtn.textContent="Remove";
      rmBtn.onclick=()=>removePosition(cat,pos.id);

      // Tick
      const checkWrap=document.createElement("div");
      checkWrap.className="position-field";
      const checkLabel=document.createElement("label");
      checkLabel.className="check-label";
      checkLabel.textContent="Tick";
      const checkBox=document.createElement("div");
      checkBox.className="check-box";
      if(pos.checked){
        checkBox.textContent="✓";
        checkBox.classList.add("check-active");
      }
      checkBox.onclick=()=>{
        pos.checked=!pos.checked;
        if(pos.checked){
          checkBox.textContent="✓";
          checkBox.classList.add("check-active");
        } else {
          checkBox.textContent="";
          checkBox.classList.remove("check-active");
        }
        savePositions();
      };

      checkWrap.appendChild(checkLabel);
      checkWrap.appendChild(checkBox);

      // Combine row
      row.appendChild(tickerWrap);
      row.appendChild(percentWrap);
      row.appendChild(baseWrap);
      row.appendChild(stableWrap);
      row.appendChild(rmBtn);
      row.appendChild(checkWrap);

      return row;
    }

    function updateTicker(cat,id,val){
      const arr=getArray(cat);
      const p=arr.find(x=>x.id===id);
      if(p){p.ticker=val;savePositions();}
    }
    function updatePercentOfFull(cat,id,val){
      const arr=getArray(cat);
      const p=arr.find(x=>x.id===id);
      if(p){p.percentOfFull=val;savePositions();}
    }
    function getArray(cat){
      return cat==="core"?corePositions:(cat==="spec"?specPositions:reservePositions);
    }
    function savePositions(){
      localStorage.setItem("corePositions",JSON.stringify(corePositions));
      localStorage.setItem("specPositions",JSON.stringify(specPositions));
      localStorage.setItem("reservePositions",JSON.stringify(reservePositions));
    }
    function loadPositions(){
      let c=localStorage.getItem("corePositions");
      let s=localStorage.getItem("specPositions");
      let r=localStorage.getItem("reservePositions");
      corePositions=c?JSON.parse(c):[];
      specPositions=s?JSON.parse(s):[];
      reservePositions=r?JSON.parse(r):[];

      if(corePositions.length===0){
        corePositions.push({id:"core-"+Date.now(),ticker:"",percentOfFull:"",baseAlloc:"",stableAlloc:"",checked:false});
      }
      if(specPositions.length===0){
        specPositions.push({id:"spec-"+Date.now(),ticker:"",percentOfFull:"",baseAlloc:"",stableAlloc:"",checked:false});
      }
      if(reservePositions.length===0){
        reservePositions.push({id:"reserve-"+Date.now(),ticker:"",percentOfFull:"",baseAlloc:"",stableAlloc:"",checked:false});
      }
    }

    /* EXCHANGE RATES + immediate conversion */
    async function updateExchangeRates(){
      const base=document.getElementById("baseCurrency").value;
      try{
        const resp=await fetch(`https://api.exchangerate-api.com/v4/latest/${base}`);
        if(!resp.ok)throw new Error("Bad response");
        const data=await resp.json();
        exchangeData[base]=data;
        alert("Exchange rates updated!");
        showImmediateConversions();
      }catch(err){
        alert("Could not fetch live rates. Using old or no data.");
      }
    }
    function showImmediateConversions(){
      const base=document.getElementById("baseCurrency").value;
      const amount=parseFloat(document.getElementById("investmentAmount").value)||0;
      const conv=document.getElementById("conversionCurrency").value;
      const stable=document.getElementById("stablecoin").value;

      const disp=document.getElementById("immediateConversionDisplay");
      disp.innerHTML="";

      const rateToConv=getRate(base,conv);
      const rateToUSD=getRate(base,"USD");
      if(rateToConv===null||rateToUSD===null){
        disp.innerHTML=`<p style="color:red;">No live exchange rate data. Click "Get Live Rates".</p>`;
        return;
      }
      const convVal=amount*(rateToConv||1);
      const stableVal=amount*(rateToUSD||1);
      disp.innerHTML=`
        <p><strong>Immediate Conversion:</strong><br/>
        ${amount.toLocaleString()} ${base} =
        ${convVal.toLocaleString()} ${conv},
        = ${stableVal.toLocaleString()} ${stable}
        </p>
      `;
    }

    /* CALCULATE ALLOCATIONS (No "Allocated" col) */
    function calculateAllocations(){
      const base=document.getElementById("baseCurrency").value;
      const amount=parseFloat(document.getElementById("investmentAmount").value)||0;
      const conv=document.getElementById("conversionCurrency").value;
      const stable=document.getElementById("stablecoin").value;

      const cPct=parseInt(document.getElementById("corePct").value)||0;
      const sPct=parseInt(document.getElementById("specPct").value)||0;
      const rPct=parseInt(document.getElementById("reservePct").value)||0;
      const totalPct=cPct+sPct+rPct;
      if(totalPct!==100){
        const proceed=confirm(`Warning: categories total ${totalPct}%. Continue anyway?`);
        if(!proceed)return;
      }

      const rounding=parseFloat(prompt("Enter rounding increment (e.g. 500):","500"))||500;
      const rateToConv=getRate(base,conv);
      const rateToUSD=getRate(base,"USD");
      if(rateToConv===null||rateToUSD===null){
        alert("No valid exchange rates. Please Get Live Rates first.");
        return;
      }
      function roundToNearest(val,inc){return Math.round(val/inc)*inc;}

      const coreBudget=(cPct/100)*amount;
      const specBudget=(sPct/100)*amount;
      const reserveBudget=(rPct/100)*amount;

      let allocations=[];
      function allocateCategory(arr,catName,budget){
        let sumFactors=arr.reduce((acc,x)=>acc+parseFloat(x.percentOfFull||0),0);
        if(sumFactors===0) sumFactors=1;
        arr.forEach(p=>{
          const factor=parseFloat(p.percentOfFull||0);
          const rawAlloc=(factor/sumFactors)*budget;
          const allocBase=roundToNearest(rawAlloc,rounding);
          const allocConv=roundToNearest(allocBase*(rateToConv||1),rounding);
          const allocStable=roundToNearest(allocBase*(rateToUSD||1),rounding);

          p.baseAlloc=allocBase.toString();
          p.stableAlloc=allocStable.toString();

          allocations.push({
            category:catName,
            ticker:p.ticker||"(none)",
            baseAlloc:allocBase,
            convAlloc:allocConv,
            stableAlloc:allocStable
          });
        });
      }
      allocateCategory(corePositions, "Core", coreBudget);
      allocateCategory(specPositions,"Speculative", specBudget);
      allocateCategory(reservePositions,"Reserve", reserveBudget);

      savePositions();
      renderAllPositions();

      const sumBase=allocations.reduce((a,b)=>a+b.baseAlloc,0);
      const sumConv=allocations.reduce((a,b)=>a+b.convAlloc,0);
      const sumStable=allocations.reduce((a,b)=>a+b.stableAlloc,0);

      let html=`
        <h2>Results</h2>
        <p><strong>Total ${base} Entered:</strong> ${amount.toLocaleString()} ${base}</p>
        <p>Equivalent in ${conv}: ${(amount*(rateToConv||1)).toLocaleString()} ${conv} |
           in ${stable}: ${(amount*(rateToUSD||1)).toLocaleString()} ${stable}</p>
        <table>
          <tr>
            <th>Category</th>
            <th>Ticker</th>
            <th>Allocation (${base})</th>
            <th>Allocation (${conv})</th>
            <th>Allocation (${stable})</th>
          </tr>
      `;
      allocations.forEach(a=>{
        html+=`
          <tr>
            <td>${a.category}</td>
            <td>${a.ticker}</td>
            <td>${a.baseAlloc.toLocaleString()}</td>
            <td>${a.convAlloc.toLocaleString()}</td>
            <td>${a.stableAlloc.toLocaleString()}</td>
          </tr>
        `;
      });
      html+=`
          <tr>
            <td colspan="2"><strong>Total</strong></td>
            <td><strong>${sumBase.toLocaleString()} ${base}</strong></td>
            <td><strong>${sumConv.toLocaleString()} ${conv}</strong></td>
            <td><strong>${sumStable.toLocaleString()} ${stable}</strong></td>
          </tr>
        </table>
      `;
      document.getElementById("results").innerHTML=html;
    }
  </script>
</body>
</html>